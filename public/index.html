<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Agente WhatsApp – Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b0b0c;
        --bg-elev: #121214;
        --text: #f7f5f0;
        --muted: #9b998f;
        --gold: #d4af37;
        --gold-weak: #c7a431;
        --stroke: #1e1f22;
        --focus: #e2c566;
      }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 960px; margin: 32px auto; padding: 0 16px; background: radial-gradient(1200px 600px at 80% -20%, rgba(212,175,55,0.08), rgba(0,0,0,0)) , var(--bg); color: var(--text); }
      h1 { margin-bottom: 8px; letter-spacing: 0.2px; }
      .muted { color: var(--muted); }
      .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
      .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0)); border: 1px solid var(--stroke); border-radius: 12px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04); }
      label { display: block; margin: 10px 0 6px; font-weight: 600; color: var(--text); }
      textarea { width: 100%; min-height: 180px; padding: 12px 14px; font: inherit; background: var(--bg); color: var(--text); border: 1px solid var(--stroke); border-radius: 10px; outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
      textarea:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212,175,55,0.2); }
      input[type="range"] { width: 100%; accent-color: var(--gold); }
      button { padding: 12px 18px; border: 1px solid var(--gold); border-radius: 10px; font-weight: 700; cursor: pointer; background: linear-gradient(180deg, #1a1a1d, #0f0f11); color: var(--text); transition: transform .05s ease, box-shadow .2s ease, background .2s ease; box-shadow: 0 8px 20px rgba(212,175,55,0.15), inset 0 1px 0 rgba(255,255,255,0.06); }
      button:hover { background: linear-gradient(180deg, #212124, #141417); box-shadow: 0 10px 26px rgba(212,175,55,0.22); }
      button:active { transform: translateY(1px); }
      .row { display: flex; gap: 12px; align-items: center; }
      .ok { color: #34d399; }
      .err { color: #ef4444; }
      .status-dot { width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px; box-shadow: 0 0 0 3px rgba(255,255,255,0.03); }
      #qrImg { background: #0e0e10; }
      .kpi { display:flex; align-items:center; gap:10px; font-weight:600; }
      .header { display:flex; justify-content:space-between; align-items:center; }
      .badge { border:1px solid var(--gold); color: var(--gold); padding:4px 10px; border-radius:999px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; }
      @media (min-width: 900px) {
        .grid { grid-template-columns: 1.2fr 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>Agente WhatsApp – Admin</h1>
        <p class="muted">Edite o prompt e a temperatura. Escaneie o QR para conectar o número.</p>
      </div>
      <div class="badge">Painel</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row kpi">
          <div id="connDot" class="status-dot" style="background:#444;"></div>
          <div id="connText">Verificando conexão…</div>
        </div>
        <div style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap: 12px;">
          <img id="qrImg" alt="QR" style="display:none;border:1px dashed var(--gold);border-radius:12px;padding:10px; max-width: 320px;" />
          <div id="qrHint" class="muted" style="display:none;margin-top:2px;">Abra o WhatsApp → Aparelhos conectados → Conectar um aparelho e escaneie.</div>
        </div>
      </div>

      <div class="card">
        <label for="prompt">Prompt do sistema</label>
        <textarea id="prompt"></textarea>

        <label for="temp">Temperatura: <span id="tempValue">0.7</span></label>
        <input id="temp" type="range" min="0" max="2" step="0.1" value="0.7"/>

        <div class="row" style="margin-top:12px;">
          <button id="saveBtn">Salvar</button>
          <span id="status"></span>
        </div>
        
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--stroke);">
          <label style="margin-bottom:8px;">Gerenciar Conexão WhatsApp</label>
          <button id="disconnectBtn" style="background:linear-gradient(180deg, #2a1a1a, #1a0f0f); border-color:#c33; color:#ff6b6b;">Desconectar WhatsApp</button>
          <span id="disconnectStatus" style="margin-left:8px;"></span>
        </div>
      </div>
    </div>

    <script>
      const promptEl = document.getElementById('prompt');
      const tempEl = document.getElementById('temp');
      const tempValueEl = document.getElementById('tempValue');
      const saveBtn = document.getElementById('saveBtn');
      const statusEl = document.getElementById('status');
      const connDot = document.getElementById('connDot');
      const connText = document.getElementById('connText');
      const qrImg = document.getElementById('qrImg');
      const qrHint = document.getElementById('qrHint');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const disconnectStatus = document.getElementById('disconnectStatus');

      async function loadSettings() {
        const res = await fetch('/api/settings');
        const data = await res.json();
        promptEl.value = data.system_prompt || '';
        tempEl.value = data.temperature ?? 0.7;
        tempValueEl.textContent = tempEl.value;
      }

      async function pollStatus() {
        try {
          const s = await (await fetch('/admin/status')).json();
          connDot.style.background = s.connected ? '#0a7' : (s.hasQR ? '#f90' : '#c33');
          connText.textContent = s.connected ? 'Conectado ao WhatsApp' : (s.hasQR ? 'Aguardando conexão: escaneie o QR' : 'Aguardando QR…');
          if (s.hasQR) {
            qrImg.src = '/admin/qr.png?ts=' + Date.now();
            qrImg.style.display = 'block';
            qrHint.style.display = 'block';
          } else {
            qrImg.style.display = 'none';
            qrHint.style.display = 'none';
          }
        } catch {}
      }

      tempEl.addEventListener('input', () => tempValueEl.textContent = tempEl.value);

      saveBtn.addEventListener('click', async () => {
        statusEl.textContent = '';
        try {
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ system_prompt: promptEl.value, temperature: parseFloat(tempEl.value) })
          });
          const data = await res.json();
          if (data.ok) { statusEl.textContent = 'Salvo!'; statusEl.className = 'ok'; }
          else { statusEl.textContent = data.error || 'Erro'; statusEl.className = 'err'; }
        } catch {
          statusEl.textContent = 'Erro de rede';
          statusEl.className = 'err';
        }
      });

      disconnectBtn.addEventListener('click', async () => {
        if (!confirm('Tem certeza que deseja desconectar o WhatsApp? Isso irá limpar a autenticação atual e gerar um novo QR para conectar um novo número.')) {
          return;
        }
        disconnectStatus.textContent = 'Desconectando...';
        disconnectStatus.className = '';
        disconnectBtn.disabled = true;
        try {
          const res = await fetch('/api/disconnect', { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            disconnectStatus.textContent = 'Desconectado! Novo QR será gerado em breve.';
            disconnectStatus.className = 'ok';
            setTimeout(() => {
              disconnectStatus.textContent = '';
              disconnectBtn.disabled = false;
            }, 3000);
          } else {
            disconnectStatus.textContent = data.error || 'Erro ao desconectar';
            disconnectStatus.className = 'err';
            disconnectBtn.disabled = false;
          }
        } catch {
          disconnectStatus.textContent = 'Erro de rede';
          disconnectStatus.className = 'err';
          disconnectBtn.disabled = false;
        }
      });

      loadSettings();
      pollStatus();
      setInterval(pollStatus, 2000);
    </script>
  </body>
</html>
